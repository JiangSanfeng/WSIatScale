import os
import numpy as np

from analyze import *
from transformers import AutoTokenizer

preds_dir = 'tests/stubs'

def test_find_token_idx_in_row():
    token = 111 # vocab id for "the"
    with open(os.path.join(preds_dir, 'in_words.npy'), 'rb') as words_f:
        tokens = np.load(words_f)
    token_idx_in_row = find_token_idx_in_row(tokens, token)
    assert all(token_idx_in_row[:7] == [5, 32, 60, 66, 78, 96, 99])
    assert len(token_idx_in_row) == 50

def test_find_sents_with_token():
    token = 111 # vocab id for "have"
    with open(os.path.join(preds_dir, 'in_words.npy'), 'rb') as words_f, open(os.path.join(preds_dir, 'sent_lengths.npy'), 'rb') as lengths_f:
        tokens = np.load(words_f)
        lengths = np.load(lengths_f)
        token_idx_in_row = find_token_idx_in_row(tokens, token)
        sent_and_positions = list(find_sent_and_positions(token_idx_in_row, tokens, lengths))
        for sent, token_pos_in_sent, _ in sent_and_positions:
            assert token in sent
            for pos in token_pos_in_sent:
                assert sent[pos] == token

sent = np.array([8949,141,568,220,14152,3846,147,4592,6867,2465,422,2599,24345,30113,137,1968,17814,334,2950,1445,147,106,1265,131,337,166,19603,205,580,1454,241,235,1265,923,131,3954,9814,422,106,2999,131,4617,960,422,137,23609,422,334,14152,3846,6888,147,3228,5539,205,1972,6025,2999,4752,6753,147,1972,7411,214,1953,6686,115,3097,205,1904,6454,862,8974,198,5186,12987,165,482,131,111,1164,4080,131,7560,3105,11740,28051,30113,422,2825,603,568,235,1265,168,2957,3018,360,528,121,3644,4815,168,8320,5081,131,532,205,820,776,862,106,5645,579,996,4289,508,190,1211,579,170,3604,137,3167,18874,5283,1288,422,975,883,883,106,22487,10411,22815,248,168,130,5396,11737,502,1976,1548,422,241,11295,190,106,239,579,2181,2999,131,11299,13677,137,27213,191,14353,329,205,299,883,528,191,8320,5630,2619,147,6367,9846,131,1972,6894,205,191,7512,299,241,17171,422,190,11919,10322,671,235,111,13419,565,131,111,12521,137,2664,10062,14053,235,111,3183,9833,205,461,241,425,8678,131,26516,30121,137,111,2619,131,111,5283,689,241,8361,3666,318,205,7400,30114,1367,3105,11740,14104,12461,30113,28850,190,8697,18760,24522,30113,137,7099,3162,132,2469,205,15795,2493,131,111,8693,2992,147,3346,556,5186,23705,1367,8697,18760,24522,30113,137,8697,6603,458,3105,11740,28051,30113,1319,1775,131,23705,205,14615,5186,12987,241,11417,137,111,1454,241,2940,5633,692,121,5630,422,137,906,878,531,4858,30107,205,1972,3049,137,7400,30114,7875,9098,121,170,1976,205,28103,21114,4760,241,797,147,195,10098,5161,235,6885,30145,6001,1352,1965,137,130,11401,6155,3804,6927,6368,190,130,6431,131,1012,1863,205,111,14615,5542,131,238,568,5186,12987,241,4458,214,106,15669,907,191,111,5186,8100,422,3111,214,1972,8320,3886,131,111,5144,16615,3519,1607,188,1188,131,111,1837,131,1972,7599,6894,2010,205,5214,1352,2126,862,5186,12987,4400,5109,179,190,8697,6495,26369,138,14104,12461,30113,7428,106,4199,12688,6540,191,7400,30114,205,121,5793,3765,214,15669,1056,234,7755,121,3183,10045,422,188,121,12563,234,5186,23705,422,5186,12987,552,709,121,1279,3790,4568,205,3325,16444,26717,434,528,1214,188,7879,2083,3105,11740,5186,12987,137,14986,5186,12987,434,528,6220,147,111,15669,1056,131,17810,205,407,14615,15986,300,195,26009,190,9520,137,17058,205,147,2113,111,2996,2716,121,568,190,14615,7400,30114,2505,112,422,10838,1691,8520,191,494,1329,137,15406,247,141,6482,131,2957,3018,137,2636,106,11012,2999,205])

def test_find_full_sent_around_token_beginning():
    single_sent = find_single_sent_around_token(sent, 5)
    gold = np.array([8949,141,568,220,14152,3846,147,4592,6867,2465,422,2599,24345,30113,137,1968,17814,334,2950,1445,147,106,1265,131,337,166,19603,205])
    assert all(single_sent == gold)

def test_find_full_sent_around_token_middle():
    single_sent = find_single_sent_around_token(sent, 391)
    gold = np.array([5214,1352,2126, 862,5186,12987,4400,5109,179,190,8697,6495,26369,138,14104,12461,30113,7428,106,4199,12688,6540,191,7400,30114,205])
    assert all(single_sent == gold)

def test_find_full_sent_around_token_end():
    single_sent = find_single_sent_around_token(sent, 495)
    gold = np.array([147,2113,111,2996,2716,121,568,190,14615,7400,30114,2505,112,422,10838,1691,8520,191,494,1329,137,15406,247,141,6482,131,2957,3018,137,2636,106,11012,2999,205])
    assert all(single_sent == gold)